<!-- main.html -->
<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <title>智慧农业 - 主控制台</title>
    <link rel="icon" href="/assets/img/nputxt.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* 让 iframe 撑满剩余高度 */
        #content-frame {
            width: 100%;
            height: calc(100vh - 64px);
            /* 减去顶部栏高度 */
            border: none;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- 顶部统一导航 -->
    <header class="shadow-lg sticky top-0 z-50" style="background-color: rgba(31,41,55,.95);">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <!-- 左侧图标 + 文字（完全照搬） -->
                <a href="homepage.html" class="flex items-center space-x-2">
                    <i class="fa fa-leaf text-2xl" style="color:#22c55e !important"></i>
                    <span class="text-xl font-bold text-white">Agri Platform</span>
                    <span class="text-gray-300 ml-4">| 智慧农业控制台</span>
                </a>

                <!-- 中间一排按钮 -->
                <nav class="flex space-x-2">
                    <!-- 农场主 -->
                    <button data-role="farm_owner" onclick="showPage('/planning-mgmt.html')"
                        class="px-3 py-1.5 rounded hover:bg-primary/20 text-white hover:text-primary transition-colors">种植监控</button>
                    <button data-role="farm_owner" onclick="showPage('/farm_owner2.html')"
                        class="px-3 py-1.5 rounded hover:bg-primary/20 text-white hover:text-primary transition-colors">土地管理</button>
                    <button data-role="farm_owner" onclick="showPage('/tech_advisor2.html')"
                        class="px-3 py-1.5 rounded hover:bg-primary/20 text-white hover:text-primary transition-colors">技术顾问</button>
                    <!-- 管理员 -->
                    <button data-role="sys_admin" onclick="showPage('/user-role.html')"
                        class="px-3 py-1.5 rounded hover:bg-primary/20 text-white hover:text-primary transition-colors">用户中心</button>
                    <!-- 数据分析师 -->
                    <button data-role="data_analyst" onclick="showPage('/yield-market.html')"
                        class="px-3 py-1.5 rounded hover:bg-primary/20 text-white hover:text-primary transition-colors">产量市场</button>
                </nav>

                <!-- 右侧头像下拉 -->
                <div class="relative flex items-center space-x-2 group">
                    <div class="flex items-center space-x-2 cursor-pointer">
                        <img src="https://picsum.photos/id/1005/40/40" alt="头像"
                            class="w-8 h-8 rounded-full object-cover">
                        <span class="text-sm font-medium text-white" id="top-username">农场主A</span>
                    </div>
                    <div
                        class="hidden group-hover:block absolute right-0 top-full w-48 bg-white rounded-xl shadow-lg p-3 z-50 flex flex-col gap-2">
                        <button id="go-profile"
                            class="w-full bg-primary hover:bg-primary/90 text-white text-sm py-2 rounded">完善信息</button>
                        <button id="logout-btn"
                            class="w-full border border-gray-300 hover:border-primary hover:text-primary text-sm py-2 rounded">退出登录</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 内容容器：用 iframe 嵌入各个子页面 -->
    <iframe id="content-frame" src="/planning-mgmt.html" class="pt-4 pb-4"></iframe>

    <script>
        /* ====== 调试：不跳转，只看数据 ====== */
        (function () {
            const rolesRaw = localStorage.getItem('roles');
            const uname = localStorage.getItem('uname');
            console.log('=== 本地存储 ===');
            console.log('uid:  ', localStorage.getItem('uid'));
            console.log('uname:', uname);
            console.log('roles:', rolesRaw);

            /* 写用户名 */
            if (uname) document.getElementById('top-username').textContent = uname;

            /* 暂时不跳转，只打印警告 */
            if (!rolesRaw || rolesRaw === 'undefined') {
                console.warn('⚠ 没有可用角色，正常会跳 /login.html');
                location.href = '/login.html';   // ← 先注释掉！
                return;
            }

            /* 有角色再解析按钮权限 */
            const roles = JSON.parse(rolesRaw);
            document.querySelectorAll('nav button[data-role]').forEach(btn => {
                const need = btn.dataset.role.split(',').map(r => r.trim());
                const ok = need.some(r => roles.includes(r));
                btn.style.display = ok ? 'inline-block' : 'none';
            });
        })();

        /* ====== 其余原有代码 ====== */
        function showPage(page) {
            const iframe = document.getElementById('content-frame');
            const uid = localStorage.getItem('uid');
            if (!uid) {
                location.href = '/user-mgmt.html';
                return;
            }
            const target = page.endsWith('user-mgmt.html') ? page + '#role' : page;
            iframe.src = target;
            iframe.onload = () => {
                iframe.contentWindow.postMessage({ action: 'setLogin', uid: uid, uname: localStorage.getItem('uname') }, '*');
            };
        }
        document.getElementById('go-profile').addEventListener('click', () => {
            showPage('/user-profile.html');
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.clear();
            location.href = 'homepage.html';
        });
    </script>
</body>

</html>